{% extends "base.html" %}
{% block title %}Calendario de Turnos{% endblock %}

{% block content %}

<div class="calendario-header">
    <a class="boton-accion" href="/calendario/{{ mes_anterior.year }}/{{ mes_anterior.month }}">‹ Mes Anterior</a>
    <h2>{{ nombre_mes }} {{ ano }}</h2>
    <a class="boton-accion" href="/calendario/{{ mes_siguiente.year }}/{{ mes_siguiente.month }}">Mes Siguiente ›</a>
</div>

<div class="calendario-subnav" style="margin: 15px 0;">
    <a href="/panel">← Volver al Panel de Control</a>
</div>

<div class="calendario-tabla-wrapper">
    <table class="calendario-tabla">
        <thead>
            <tr>
                <th>Lunes</th><th>Martes</th><th>Miércoles</th><th>Jueves</th><th>Viernes</th><th>Sábado</th><th>Domingo</th>
            </tr>
        </thead>
        <tbody>
            {% for semana in dias_del_mes %}
            <tr>
                {% for dia in semana %}
                    {% if dia == 0 %}
                        <td class="dia-otro-mes"></td>
                    {% else %}
                        <td class="celda-dia {% if dia in turnos_por_dia %}dia-ocupado{% endif %} {% if dia == fecha_hoy.day and mes == fecha_hoy.month and ano == fecha_hoy.year %}dia-hoy{% endif %}" 
    data-fecha="{{ ano }}-{{ '%02d'|format(mes) }}-{{ '%02d'|format(dia) }}"
    data-url-detalle="/dia/{{ ano }}/{{ mes }}/{{ dia }}">
    
    <div class="dia-numero">{{ dia }}</div>
    
    <button class="boton-agregar-turno">+</button>

    {% if dia in turnos_por_dia %}
    <ul class="turnos-lista">
        {% for hora in turnos_por_dia[dia] %}
            <li>{{ hora }}</li>
        {% endfor %}
    </ul>
    {% endif %}
</td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="modal-turno" class="modal-oculto">
    <div class="modal-contenido">
        <span class="modal-cerrar">&times;</span>
<h3>Agendar Nuevo Turno</h3>
<div id="error-container-modal"></div> <form action="/agregar_turno" method="post" ...>

<form action="/agregar_turno" method="post" class="form-section" style="padding:0; box-shadow:none; border:0;">
    
    <div class="form-group">
        <label for="cliente_id_modal">Cliente:</label>
        <select id="cliente_id_modal" name="cliente_id" required>
            <option value="">Seleccionar cliente...</option>
            {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="servicio_id_modal">Servicio:</label>
        <select id="servicio_id_modal" name="servicio_id" required>
            <option value="">Seleccionar servicio...</option>
            {% for servicio in servicios %}
                 <option value="{{ servicio.id }}">{{ servicio.nombre }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="modal-fecha">Fecha:</label>
        <input type="date" id="modal-fecha" name="fecha" required>
    </div>
    
    <div class="form-group">
        <label for="hora_modal">Hora:</label>
        <input type="time" id="hora_modal" name="hora" required>
    </div>
    
    <button type="submit" style="width: 100%;">Agendar Turno</button>

</form>
    </div>
</div>
<div id="js-data" 
     data-datos-viejos='{{ datos_viejos | tojson | safe }}'
     data-error-flash="{{ get_flashed_messages(with_categories=['error']) | first }}">
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. DEFINIMOS LOS ELEMENTOS DEL POP-UP ---
    const modal = document.getElementById('modal-turno');
    if (!modal) return;
    
    const spanCerrar = modal.querySelector('.modal-cerrar');
    const campoFecha = modal.querySelector('#modal-fecha');
    const form = modal.querySelector('form');
    const errorContainer = modal.querySelector('#error-container-modal');

    // --- FUNCIÓN PARA ABRIR EL POP-UP (LIMPIANDO EL FORMULARIO) ---
    const abrirModal = (fecha) => {
        if (!fecha) return;
        form.reset(); // Limpia todos los campos del formulario.
        errorContainer.innerHTML = ''; // Limpia cualquier mensaje de error anterior.
        campoFecha.value = fecha; // Establece la fecha correcta.
        modal.classList.remove('modal-oculto');
        modal.classList.add('modal-visible');
    };

    // --- 2. LÓGICA PARA ABRIR EL POP-UP (PC vs MÓVIL) ---
    const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    document.querySelectorAll('.celda-dia').forEach(celda => {
        if (celda.classList.contains('dia-otro-mes')) return;

        if (isMobile) {
            // Lógica para Celulares (toque corto abre, toque largo navega)
            let pressTimer;
            let isLongPress = false;
            celda.addEventListener('touchstart', (e) => {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    if(celda.dataset.urlDetalle) window.location.href = celda.dataset.urlDetalle;
                }, 500);
            });
            celda.addEventListener('touchend', (e) => {
                clearTimeout(pressTimer);
                if (!isLongPress) abrirModal(celda.dataset.fecha);
            });
            celda.addEventListener('touchmove', () => clearTimeout(pressTimer));
        } else {
            // Lógica para PC (clic en celda navega, clic en '+' abre)
            celda.addEventListener('click', (e) => {
                if (e.target.classList.contains('boton-agregar-turno')) return;
                if(celda.dataset.urlDetalle) window.location.href = celda.dataset.urlDetalle;
            });
            const botonPC = celda.querySelector('.boton-agregar-turno');
            if (botonPC) {
                botonPC.addEventListener('click', (e) => {
                    e.stopPropagation();
                    abrirModal(celda.dataset.fecha);
                });
            }
        }
    });

    // --- 3. LÓGICA PARA ENVIAR EL FORMULARIO SIN RECARGAR (AJAX) ---
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        errorContainer.innerHTML = '';
        const formData = new FormData(form);

        fetch('/agregar_turno', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                modal.classList.add('modal-oculto');
                window.location.reload(); 
            } else {
                errorContainer.innerHTML = `<div class="alerta flash-error">${data.message}</div>`;
            }
        })
        .catch(error => {
            errorContainer.innerHTML = `<div class="alerta flash-error">Error de conexión. Intentalo de nuevo.</div>`;
        });
    });

    // --- 4. CÓDIGO PARA CERRAR EL POP-UP (VERSIÓN ROBUSTA) ---
    const cerrarModal = () => {
        modal.classList.remove('modal-visible');
        modal.classList.add('modal-oculto');
        if (errorContainer) {
            errorContainer.innerHTML = '';
        }
    };

    if (spanCerrar) {
        spanCerrar.addEventListener('click', cerrarModal);
    }
    modal.addEventListener('click', (event) => {
        if (event.target === modal) {
            cerrarModal();
        }
    });
});
</script>
{% endblock %}