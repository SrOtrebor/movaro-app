{% extends "base.html" %}

{% block title %}Campañas de Mensajes{% endblock %}

{% block content %}
    <div id="js-data-container" data-limpiar-storage="{{ limpiar_storage }}" style="display: none;"></div>
    <h1>Campañas de Mensajes Masivos</h1>
    <p>
        Seleccioná una de tus plantillas para generar enlaces de WhatsApp personalizados para todos tus clientes.
    </p>
    <hr>

    <div class="card" style="margin-bottom: 30px;">
        <h2>Paso 1: Elegir Plantilla</h2>
        <form action="/campanas" method="post" style="display: flex; gap: 15px; align-items: flex-end;">
            <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                <label for="plantilla_id">Seleccioná la plantilla que querés enviar:</label>
                <select id="plantilla_id" name="plantilla_id" class="form-control" required>
                    <option value="">-- Elegí una plantilla --</option>
                    {% for plantilla in plantillas %}
                        <option value="{{ plantilla.id }}">{{ plantilla.tipo_mensaje }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit">Generar Lista</button>
        </form>
    </div>

    {% if clientes_con_wa %}
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Paso 2: Enviar Mensajes</h2>
            <a href="/campanas/limpiar" class="boton-accion" style="background-color: #6c757d;">Limpiar y Empezar de Nuevo</a>
        </div>
        
        <p>Se generaron links para <strong>{{ clientes_con_wa|length }}</strong> cliente(s) usando la plantilla:</p>
        <blockquote style="border-left: 3px solid var(--color-borde-suave); padding-left: 15px; font-style: italic;">
            {{ plantilla_seleccionada_texto }}
        </blockquote>
        <hr>
        <p>Hacé clic en cada botón para abrir WhatsApp y enviar el mensaje. Tu progreso se guardará automáticamente.</p>
        
        <table class="stats-table tabla-responsiva">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for cliente in clientes_con_wa %}
                <tr>
                    <td data-label="Cliente">{{ cliente.nombre }} {{ cliente.apellido }}</td>
                    <td data-label="Acción">
                        <a href="{{ cliente.link_wa }}" target="_blank" class="boton-accion boton-envio-wa" data-cliente-id="{{ cliente.id }}">
                            Enviar Mensaje
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const CAMPAIGN_STORAGE_KEY = 'sent_clients';

        // Función para marcar un botón como "Enviado"
        const marcarComoEnviado = (boton) => {
            if (!boton) return;
            boton.textContent = 'Enviado ✔️';
            boton.style.backgroundColor = '#6c757d';
            boton.style.opacity = '0.7';
            boton.style.pointerEvents = 'none';
        };

        // 1. Al cargar la página, revisamos la memoria del navegador
        const sentClients = JSON.parse(localStorage.getItem(CAMPAIGN_STORAGE_KEY) || '[]');
        document.querySelectorAll('.boton-envio-wa').forEach(boton => {
            const clienteId = boton.dataset.clienteId;
            if (sentClients.includes(clienteId)) {
                marcarComoEnviado(boton);
            }
        });

        // 2. Al hacer clic en un botón, guardamos su estado
        document.querySelectorAll('.boton-envio-wa').forEach(boton => {
            boton.addEventListener('click', function() {
                const clienteId = boton.dataset.clienteId;
                let currentSent = JSON.parse(localStorage.getItem(CAMPAIGN_STORAGE_KEY) || '[]');
                if (!currentSent.includes(clienteId)) {
                    currentSent.push(clienteId);
                }
                localStorage.setItem(CAMPAIGN_STORAGE_KEY, JSON.stringify(currentSent));
                marcarComoEnviado(boton);
            });
        });

        // 3. Si el servidor nos pide limpiar la memoria, lo hacemos (CÓDIGO CORREGIDO)
        const dataContainer = document.getElementById('js-data-container');
        // Leemos la señal desde el atributo data-* del div
        // Python convierte True en el string 'True', por eso la comparación
        const needsToClear = dataContainer.dataset.limpiarStorage === 'True';
        
        if (needsToClear) {
            localStorage.removeItem(CAMPAIGN_STORAGE_KEY);
            // Redirigimos para que la página se actualice sin la señal y los botones se reseteen
            window.location.href = '/campanas';
        }
    });
</script>

{% endblock %}