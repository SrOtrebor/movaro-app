{% extends "base.html" %}

{% block title %}Detalle de {{ clienta.nombre }} {{ clienta.apellido }}{% endblock %}

{% block content %}
    <a href="/clientes">← Volver al listado de clientes</a>
    <hr>

    <div class="detalle-cliente-container">
        <!-- Columna de Detalles del Cliente (30%) -->
        <div class="col-detalle-cliente">
            <div class="card">
                <div class="avatar-container">
                    {% if clienta.avatar_path %}
                        <img src="{{ url_for('static', filename='uploads/' + clienta.avatar_path) }}" alt="Avatar" class="avatar-img">
                    {% else %}
                        <div class="avatar-placeholder">{{ clienta.nombre[0] if clienta.nombre }}</div>
                    {% endif %}
                </div>
                
                <h2>{{ clienta.nombre }} {{ clienta.apellido }}</h2>
                <p><strong>Teléfono:</strong> {{ clienta.telefono or 'No especificado' }}</p>
                <p><strong>Cumpleaños:</strong> {{ clienta.cumpleanos or 'No especificado' }}</p>

                <hr>

                <form action="/subir_avatar" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="avatar">Cambiar foto de perfil:</label>
                        <input type="hidden" name="cliente_id" value="{{ clienta.id }}">
                                                <input type="file" id="avatar" name="avatar" accept="image/*" required class="form-control">
                    </div>
                    <button type="submit" style="width:100%;">Subir Foto</button>
                </form>
            </div>
        </div>

        <!-- Columna de Historial de Turnos (70%) -->
        <div class="col-historial-turnos">
            <h2>Historial de Turnos</h2>
            {% if turnos %}
                {% for turno in turnos %}
                    <div class="card turno-card">
                        <div class="turno-card-header">
                            <h4>Turno del {{ turno.fecha }} a las {{ turno.hora }}</h4>
                            <p><strong>Servicio:</strong> {{ turno.servicio_nombre }}</p>
                        </div>
                        
                        <div class="turno-media-container">
                            {% if turno.foto_path %}
                                <div class="turno-foto-container">
                                    <p><strong>Foto del trabajo:</strong></p>
                                    <img src="{{ url_for('static', filename='uploads/' + turno.foto_path) }}" alt="Foto del trabajo" class="turno-foto-thumbnail">
                                </div>
                            {% endif %}
                            
                            <div class="turno-form-container">
                                <form action="/subir_foto" method="post" enctype="multipart/form-data" class="form-subir-foto">
                                    <input type="hidden" name="turno_id" value="{{ turno.id }}">
                                    <input type="hidden" name="cliente_id" value="{{ clienta.id }}">
                                    <div class="form-group">
                                        <label for="foto-turno-{{ turno.id }}">
                                            {% if turno.foto_path %}Cambiar foto{% else %}Subir foto{% endif %}:
                                        </label>
                                        <!-- Este único input le dará a elegir al usuario entre galería o cámara en el móvil -->
                                        <input type="file" id="foto-turno-{{ turno.id }}" name="foto_turno" accept="image/*" class="form-control" required>
                                    </div>
                                    <button type="submit">Guardar Foto</button>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="card">
                    <p>Este cliente aún no tiene turnos registrados.</p>
                </div>
            {% endif %}
        </div>
    </div>

<!-- Modal para la imagen -->
<div id="foto-modal" class="modal-foto-viewer">
    <span class="modal-foto-cerrar">&times;</span>
    <img class="modal-foto-contenido" id="img-modal">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos del modal
    const modal = document.getElementById('foto-modal');
    const modalImg = document.getElementById('img-modal');
    const spanCerrar = document.querySelector('.modal-foto-cerrar');

    // Todas las imágenes de la galería
    const thumbnails = document.querySelectorAll('.turno-foto-thumbnail');

    thumbnails.forEach(img => {
        img.addEventListener('click', function() {
            modal.style.display = "flex";
            modalImg.src = this.src;
        });
    });

    // Función para cerrar el modal
    const cerrarModal = () => {
        modal.style.display = "none";
    }

    // Eventos para cerrar
    if(spanCerrar) {
        spanCerrar.addEventListener('click', cerrarModal);
    }
    modal.addEventListener('click', (event) => {
        // Cierra si se hace clic en el fondo oscuro
        if (event.target === modal) {
            cerrarModal();
        }
    });
});
</script>

{% endblock %}