{% extends "base.html" %}

{% block title %}Panel de Control{% endblock %}

{% block content %}
<div class="layout-container">
    <div class="layout-col-principal">
        <h2>Alertas de Hoy</h2>

        {% if alerta_vencimiento %}
            <div class="alerta alerta-vencimiento">
                <h3>üîî Vencimiento Pr√≥ximo</h3>
                <p>{{ alerta_vencimiento }} Por favor, contact√° al administrador para renovarla.</p>
            </div>
        {% endif %}

        {% if cumpleaneras %}
            <div class="alerta alerta-cumple">
                <h3>üéÇ ¬°Feliz Cumplea√±os!</h3>
                <ul>
                    {% for clienta in cumpleaneras %}
                        <li>
                            <strong>{{ clienta.nombre }} {{ clienta.apellido }}</strong> -
                            {% set texto_cumple = "¬°Hola " ~ clienta.nombre ~ "! ü•≥ Te deseo un muy feliz cumplea√±os. Para celebrar, te regalamos un 20% de descuento en tu pr√≥xima visita." %}
                            <a href="https://wa.me/{{ clienta.telefono_wa }}?text={{ texto_cumple | urlencode }}" target="_blank">Enviar Saludo</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if turnos_manana %}
            <div class="alerta alerta-turno">
                <h3>üóìÔ∏è Recordatorios para Ma√±ana</h3>
                <ul>
                    {% for turno in turnos_manana %}
                        <li>
                            <strong>{{ turno.hora }} - {{ turno.cliente_nombre }}</strong> ({{ turno.servicio_nombre }}) -
                            {% set texto_recordatorio = "¬°Hola " ~ turno.cliente_nombre.split(' ')[0] ~ "! Te escribo para recordarte tu turno de manicura ma√±ana a las " ~ turno.hora ~ ". ¬°Te espero!" %}
                            <a href="https://wa.me/{{ turno.cliente_telefono_wa }}?text={{ texto_recordatorio | urlencode }}" target="_blank">Enviar Recordatorio</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        
        {% if clientes_a_premiar %}
            <div class="alerta alerta-fidelizacion" style="background-color: #e8dff5; border-color: #d6bbfb; color: #5a189a;">
                <h3>üèÜ ¬°Clientes para Premiar!</h3>
                <ul>
                    {% for clienta in clientes_a_premiar %}
                        <li style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>
                                <strong>{{ clienta.nombre }} {{ clienta.apellido }}</strong> (alcanz√≥ los {{ clienta.total_turnos }} turnos).
                            </span>
                            <div style="display:flex; gap: 10px;">
                                {% set texto_premio = "¬°Hola " ~ clienta.nombre ~ "! ‚ú® Quer√≠a contarte que por tu fidelidad alcanzaste los " ~ clienta.total_turnos ~ " servicios y te ganaste un premio especial en tu pr√≥xima visita. ¬°Gracias por elegirme siempre!" %}
                                <a href="https://wa.me/{{ clienta.telefono_wa }}?text={{ texto_premio | urlencode }}" target="_blank" class="boton-accion boton-avisar">Avisar Premio</a>
                                <form action="/premiar_cliente" method="post" style="margin:0;">
                                    <input type="hidden" name="cliente_id" value="{{ clienta.id }}">
                                    <button type="submit" class="boton-accion">Marcar Premiado</button>
                                </form>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if clientes_inactivos %}
            <div class="alerta alerta-inactivo">
                <h3>üìà Clientes para Reactivar</h3>
                <ul>
                    {% for clienta in clientes_inactivos %}
                        <li>
                            <strong>{{ clienta.nombre }} {{ clienta.apellido }}</strong> -
                            {% set texto_reactivar = "¬°Hola " ~ clienta.nombre ~ "! ¬øC√≥mo est√°s? Hace tiempo no nos vemos. Quer√≠a contarte que tenemos nuevos dise√±os y promos. ¬°Cuando quieras pod√©s chusmear la agenda para un pr√≥ximo turno! Te mando un beso." %}
                            <a href="https://wa.me/{{ clienta.telefono_wa }}?text={{ texto_reactivar | urlencode }}" target="_blank">Contactar</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        
        {% if not cumpleaneras and not turnos_manana and not clientes_inactivos and not clientes_a_premiar and not alerta_vencimiento %}
            <p>No hay alertas para hoy. ¬°Todo tranquilo!</p>
        {% endif %}
    </div>

    <div class="layout-col-lateral">
        <h2>{{ nombre_mes }} {{ ano }}</h2>
        <table class="mini-calendario">
            <thead><tr><th>Lu</th><th>Ma</th><th>Mi</th><th>Ju</th><th>Vi</th><th>S√°</th><th>Do</th></tr></thead>
            <tbody>
                {% for semana in dias_del_mes %}
                <tr>
                    {% for dia in semana %}
                        <td class="celda-dia {% if dia == 0 %}dia-otro-mes{% elif dia in dias_con_turnos %}dia-ocupado{% endif %}{% if ano == fecha_hoy.year and mes == fecha_hoy.month and dia == fecha_hoy.day %} dia-hoy{% endif %}" data-fecha="{{ ano }}-{{ '%02d'|format(mes) }}-{{ '%02d'|format(dia) }}">
                            {% if dia != 0 %}<div class="dia-numero">{{ dia }}</div>{% endif %}
                        </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <hr>
        <h2>Configuraci√≥n</h2>
        <form action="/panel" method="post">
            <label>Premiar cada:</label>
            <input type="number" name="meta_fidelizacion" min="1" value="{{ meta_actual }}">
            <label>servicios.</label>
            <button type="submit">Guardar</button>
        </form>
    </div>
</div>

<div id="modal-turno" class="modal-oculto">
    <div class="modal-contenido">
        <span class="modal-cerrar">&times;</span>
<h3>Agendar Nuevo Turno</h3>
<div id="error-container-modal"></div>

<form action="/agregar_turno" method="post" class="form-section" style="padding:0; box-shadow:none; border:0;">
    
    <div class="form-group">
        <label for="cliente_id_modal">Cliente:</label>
        <select id="cliente_id_modal" name="cliente_id" required>
            <option value="">Seleccionar cliente...</option>
            {% for cliente in clientes %}
                <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="servicio_id_modal">Servicio:</label>
        <select id="servicio_id_modal" name="servicio_id" required>
            <option value="">Seleccionar servicio...</option>
            {% for servicio in servicios %}
                 <option value="{{ servicio.id }}">{{ servicio.nombre }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="modal-fecha">Fecha:</label>
        <input type="date" id="modal-fecha" name="fecha" required>
    </div>
    
    <div class="form-group">
        <label for="hora_modal">Hora:</label>
        <input type="time" id="hora_modal" name="hora" required>
    </div>
    
    <button type="submit" style="width: 100%;">Agendar Turno</button>

</form>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modal-turno');
        if (!modal) return;
        const spanCerrar = modal.querySelector('.modal-cerrar');
        const campoFecha = modal.querySelector('#modal-fecha');
        
        document.querySelectorAll('.celda-dia').forEach(celda => {
            celda.addEventListener('click', function() {
                const fechaSeleccionada = this.getAttribute('data-fecha');
                if (fechaSeleccionada) {
                    campoFecha.value = fechaSeleccionada;
                    modal.classList.remove('modal-oculto');
                    modal.classList.add('modal-visible');
                }
            });
        });

        if(spanCerrar) {
            spanCerrar.onclick = function() {
                modal.classList.remove('modal-visible');
                modal.classList.add('modal-oculto');
            }
        }
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.classList.remove('modal-visible');
                modal.classList.add('modal-oculto');
            }
        }
    });
</script>
{% endblock %}