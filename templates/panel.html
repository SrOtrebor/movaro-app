{% extends "base.html" %}

{% block title %}Panel de Control{% endblock %}

{% block content %}
<div class="layout-container">
    
    <div class="layout-col-principal">
        <div class="card">
            <h2>Alertas de Hoy</h2>

            {% if plantillas_campana %}
            <div class="alerta alerta-campana">
                <h3>üöÄ Campa√±as de Marketing</h3>
                <p>Inicia un env√≠o masivo a todos tus clientes usando una de tus plantillas.</p>
                <form action="/campanas" method="post" class="form-campana-panel">
                    <div class="form-group">
                        <select name="plantilla_id" class="form-control" required>
                            <option value="">Eleg√≠ una plantilla de campa√±a...</option>
                            {% for plantilla in plantillas_campana %}
                                <option value="{{ plantilla.id }}">{{ plantilla.tipo_mensaje }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="boton-accion">Preparar Env√≠o</button>
                </form>
            </div>
            {% endif %}
            
            {% if alerta_vencimiento %}
                <div class="alerta alerta-vencimiento">
                    <h3>üîî Vencimiento Pr√≥ximo</h3>
                    <p>{{ alerta_vencimiento }} Por favor, contact√° al administrador para renovarla.</p>
                </div>
            {% endif %}

            {% if cumpleaneras %}
                <div class="alerta alerta-cumple">
                    <h3>üéÇ ¬°Feliz Cumplea√±os!</h3>
                    <ul>
                        {% for clienta in cumpleaneras %}
                            <li class="item-lista-accion" id="cumple-{{ clienta.id }}">
                                <span><strong>{{ clienta.nombre }} {{ clienta.apellido }}</strong></span>
                                <div class="grupo-botones-accion">
                                    <a href="https://wa.me/{{ clienta.telefono_wa }}?text={{ clienta.mensaje_wa }}" target="_blank" class="boton-accion boton-notificacion">Enviar Saludo</a>
                                    <button class="boton-accion btn-enviar-email" data-cliente-id="{{ clienta.id }}" data-asunto="¬°Feliz Cumplea√±os!" data-mensaje="{{ clienta.mensaje_wa }}">Enviar Email</button>
                                    <button class="boton-accion boton-eliminar-notificacion" style="display: none;">&times;</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if turnos_manana %}
                <div class="alerta alerta-turno">
                    <h3>üóìÔ∏è Recordatorios para Ma√±ana</h3>
                    <ul>
                        {% for turno in turnos_manana %}
                            <li class="item-lista-accion" id="turno-{{ turno.id }}">
                                <span><strong>{{ turno.cliente_nombre }}</strong> ({{ turno.servicio_nombre }})</span>
                                <div class="grupo-botones-accion">
                                    <a href="https://wa.me/{{ turno.cliente_telefono_wa }}?text={{ turno.mensaje_wa }}" target="_blank" class="boton-accion boton-notificacion">Enviar Recordatorio</a>
                                    <button class="boton-accion btn-enviar-email" data-cliente-id="{{ turno.cliente_id }}" data-asunto="Recordatorio de Turno" data-mensaje="{{ turno.mensaje_wa }}">Enviar Email</button>
                                    <button class="boton-accion boton-eliminar-notificacion" style="display: none;">&times;</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            {% if clientes_a_premiar %}
                <div class="alerta alerta-fidelizacion">
                    <h3>üèÜ ¬°Clientes para Premiar!</h3>
                    <ul>
                        {% for clienta in clientes_a_premiar %}
                            <li class="item-lista-accion" id="fidelizacion-{{ clienta.id }}">
                                <span><strong>{{ clienta.nombre }} {{ clienta.apellido }}</strong> ({{ clienta.total_turnos }} turnos).</span>
                                <div class="grupo-botones-accion">
                                    <a href="https://wa.me/{{ clienta.telefono_wa }}?text={{ clienta.mensaje_wa }}" target="_blank" class="boton-accion boton-notificacion">Avisar</a>
                                    <button class="boton-accion btn-enviar-email" data-cliente-id="{{ clienta.id }}" data-asunto="¬°Ganaste un premio!" data-mensaje="{{ clienta.mensaje_wa }}">Enviar Email</button>
                                    <form action="/premiar_cliente" method="post" class="form-premiar">
                                        <input type="hidden" name="cliente_id" value="{{ clienta.id }}">
                                        <button type="submit" class="boton-accion">Premiado</button>
                                    </form>
                                    <button class="boton-accion boton-eliminar-notificacion" style="display: none;">&times;</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if clientes_inactivos %}
                <div class="alerta alerta-inactivo">
                    <h3>üìà Clientes para Reactivar</h3>
                    <ul>
                        {% for clienta in clientes_inactivos %}
                            <li class="item-lista-accion" id="inactivo-{{ clienta.id }}">
                                <span><strong>{{ clienta.nombre }} {{ clienta.apellido }}</strong></span>
                                <div class="grupo-botones-accion">
                                    <a href="https://wa.me/{{ clienta.telefono_wa }}?text={{ clienta.mensaje_wa }}" target="_blank" class="boton-accion boton-notificacion">Contactar</a>
                                    <button class="boton-accion btn-enviar-email" data-cliente-id="{{ clienta.id }}" data-asunto="¬°Te extra√±amos!" data-mensaje="{{ clienta.mensaje_wa }}">Enviar Email</button>
                                    <button class="boton-accion boton-eliminar-notificacion" style="display: none;">&times;</button>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            {% if not cumpleaneras and not turnos_manana and not clientes_inactivos and not clientes_a_premiar and not alerta_vencimiento and not plantillas_campana %}
                <p>No hay alertas para hoy. ¬°Todo tranquilo!</p>
            {% endif %}
        </div>
    </div>

    <div class="layout-col-lateral">
        <div class="card" style="margin-bottom: 25px;">
            <h2>{{ nombre_mes }} {{ ano }}</h2>
            <table class="mini-calendario">
                <thead><tr><th>Lu</th><th>Ma</th><th>Mi</th><th>Ju</th><th>Vi</th><th>S√°</th><th>Do</th></tr></thead>
                <tbody>
                    {% for semana in dias_del_mes %}
                    <tr>
                        {% for dia in semana %}
                            <td class="celda-dia {% if dia == 0 %}dia-otro-mes{% elif dia in dias_con_turnos %}dia-ocupado{% endif %}{% if ano == fecha_hoy.year and mes == fecha_hoy.month and dia == fecha_hoy.day %} dia-hoy{% endif %}" data-fecha="{{ ano }}-{{ '%02d'|format(mes) }}-{{ '%02d'|format(dia) }}">
                                {% if dia != 0 %}<div class="dia-numero">{{ dia }}</div>{% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>Configuraci√≥n</h2>
            <form action="/panel" method="post">
                <div class="form-group">
                    <label>Premiar cada:</label>
                    <div class="config-fidelizacion">
                        <input type="number" name="meta_fidelizacion" min="1" value="{{ meta_actual }}" class="form-control">
                        <span>servicios.</span>
                    </div>
                </div>
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>
</div>

<div id="modal-turno" class="modal-oculto">
    <div class="modal-contenido">
        <span class="modal-cerrar">&times;</span>
        <h2>Agendar Turno</h2>
        <form id="form-agregar-turno" action="/agregar_turno" method="post">
            <div class="form-group">
                <label for="fecha_turno_modal">Fecha:</label>
                <input type="date" id="fecha_turno_modal" name="fecha" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label for="hora_turno_modal">Hora:</label>
                <input type="time" id="hora_turno_modal" name="hora" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="cliente_modal">Cliente:</label>
                <select id="cliente_modal" name="cliente_id" class="form-control" required>
                    <option value="">Selecciona un cliente</option>
                    {% for cliente in clientes %}
                        <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="servicio_modal">Servicio:</label>
                <select id="servicio_modal" name="servicio_id" class="form-control" required>
                    <option value="">Selecciona un servicio</option>
                    {% for servicio in servicios %}
                        <option value="{{ servicio.id }}">{{ servicio.nombre }} ({{ servicio.duracion }} min)</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Agendar</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- L√ìGICA PARA MARCAR NOTIFICACIONES COMO HECHAS ---
    const ID_STORAGE = 'notificaciones_desactivadas_{{ session.usuario_id }}';

    // 1. Cargar el estado desde localStorage al iniciar
    let desactivadas = JSON.parse(localStorage.getItem(ID_STORAGE)) || [];
    desactivadas.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.classList.add('desactivado');
            const botonEnviar = elemento.querySelector('.boton-notificacion');
            const botonEliminar = elemento.querySelector('.boton-eliminar-notificacion');
            if(botonEnviar) botonEnviar.style.display = 'none';
            if(botonEliminar) botonEliminar.style.display = 'inline-block';
        }
    });

    // 2. Funci√≥n para guardar el estado
    function guardarEstado(id) {
        if (!desactivadas.includes(id)) {
            desactivadas.push(id);
            localStorage.setItem(ID_STORAGE, JSON.stringify(desactivadas));
        }
    }

    // 3. Funci√≥n para eliminar una notificaci√≥n
    function eliminarNotificacion(id) {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.style.display = 'none'; // Ocultamos la notificaci√≥n
        }
        desactivadas = desactivadas.filter(item => item !== id);
        localStorage.setItem(ID_STORAGE, JSON.stringify(desactivadas));
    }

    // 4. A√±adir listeners a los botones
    document.querySelectorAll('.boton-notificacion').forEach(boton => {
        boton.addEventListener('click', function() {
            const item = this.closest('.item-lista-accion');
            const id = item.id;
            
            // Usamos un peque√±o retraso para asegurar que el link de WhatsApp se abra
            setTimeout(() => {
                item.classList.add('desactivado');
                this.style.display = 'none';
                const botonEliminar = item.querySelector('.boton-eliminar-notificacion');
                if(botonEliminar) botonEliminar.style.display = 'inline-block';
                guardarEstado(id);
            }, 500); // 500ms de espera
        });
    });

    document.querySelectorAll('.boton-eliminar-notificacion').forEach(boton => {
        boton.addEventListener('click', function() {
            const id = this.closest('.item-lista-accion').id;
            eliminarNotificacion(id);
        });
    });

    // --- L√ìGICA DEL MODAL DE TURNOS ---
    const modal = document.getElementById('modal-turno');

    // Abrir modal al hacer clic en un d√≠a del calendario
    document.querySelectorAll('.celda-dia').forEach(celda => {
        celda.addEventListener('click', function() {
            const fecha = this.dataset.fecha; // Obtiene la fecha del atributo data-fecha
            if (fecha && fecha !== 'None-None-None') { // Asegurarse de que no sea una celda vac√≠a
                const fechaInput = document.getElementById('fecha_turno_modal'); // Move inside
                const closeButton = modal.querySelector('.modal-cerrar'); // Move inside

                if (fechaInput) {
                    fechaInput.value = fecha; // Rellena el campo de fecha
                }
                modal.classList.remove('modal-oculto');
                modal.classList.add('modal-visible');

                // Add event listeners for closing the modal here, after elements are found
                if (closeButton) {
                    closeButton.onclick = function() { // Use onclick to avoid multiple listeners
                        modal.classList.remove('modal-visible');
                        modal.classList.add('modal-oculto');
                    };
                }
            }
        });
    });

    // Cerrar modal al hacer clic fuera del contenido (this can remain outside)
    window.addEventListener('click', function(event) {
        if (event.target == modal) {
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-oculto');
        }
    });

    // --- L√ìGICA PARA ENVIAR EL FORMULARIO DE TURNO CON AJAX ---
    const formTurno = document.getElementById('form-agregar-turno');
    formTurno.addEventListener('submit', function(event) {
        event.preventDefault(); // Evitamos el env√≠o tradicional

        const formData = new FormData(formTurno);
        const submitButton = formTurno.querySelector('button[type="submit"]');
        submitButton.disabled = true; // Deshabilitamos el bot√≥n para evitar doble env√≠o
        submitButton.textContent = 'Agendando...';

        fetch('/agregar_turno', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message); // Mostramos mensaje de √©xito
                window.location.reload(); // Recargamos la p√°gina para ver el nuevo turno
            } else {
                // Si hay un error, lo mostramos en una alerta
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error en la petici√≥n fetch:', error);
            alert('Ocurri√≥ un error de conexi√≥n. Por favor, intent√° de nuevo.');
        })
        .finally(() => {
            // Reactivamos el bot√≥n sea cual sea el resultado
            submitButton.disabled = false;
            submitButton.textContent = 'Agendar';
        });
    });
});
</script>
{% endblock %}