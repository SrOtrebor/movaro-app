{% extends "base.html" %}

{% block title %}Panel de Control{% endblock %}

{% block content %}
<div class="layout-container">
    
    <div class="layout-col-principal">
        <div class="card">
            <h2>Alertas de Hoy</h2>
            
            {% if alerta_vencimiento %}
                <div class="alerta alerta-vencimiento">
                    <h3>üîî Vencimiento Pr√≥ximo</h3>
                    <p>{{ alerta_vencimiento }} Por favor, contact√° al administrador para renovarla.</p>
                </div>
            {% endif %}

            {% if cumpleaneras %}
                <div class="alerta alerta-cumple">
                    <h3>üéÇ ¬°Feliz Cumplea√±os!</h3>
                    <ul>
                        {% for clienta in cumpleaneras %}
                            <li class="item-lista-accion">
                                <span><strong>{{ clienta.nombre }} {{ clienta.apellido }}</strong></span>
                                <a href="https://wa.me/{{ clienta.telefono_wa }}?text={{ clienta.mensaje_wa }}" target="_blank" class="boton-accion accion-alerta">Enviar Saludo</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if turnos_manana %}
                <div class="alerta alerta-turno">
                    <h3>üóìÔ∏è Recordatorios para Ma√±ana</h3>
                    <ul>
                        {% for turno in turnos_manana %}
                            <li class="item-lista-accion">
                                <span><strong>{{ turno.cliente_nombre }}</strong> ({{ turno.servicio_nombre }})</span>
                                <a href="https://wa.me/{{ turno.cliente_telefono_wa }}?text={{ turno.mensaje_wa }}" target="_blank" class="boton-accion accion-alerta">Enviar Recordatorio</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            {% if clientes_a_premiar %}
                <div class="alerta alerta-fidelizacion">
                    <h3>üèÜ ¬°Clientes para Premiar!</h3>
                    <ul>
                        {% for clienta in clientes_a_premiar %}
                            <li class="item-lista-accion">
                                <span><strong>{{ clienta.nombre }} {{ clienta.apellido }}</strong> ({{ clienta.total_turnos }} turnos).</span>
                                <div class="grupo-botones-accion">
                                    <a href="https://wa.me/{{ clienta.telefono_wa }}?text={{ clienta.mensaje_wa }}" target="_blank" class="boton-accion accion-alerta">Avisar</a>
                                    <form action="/premiar_cliente" method="post">
                                        <input type="hidden" name="cliente_id" value="{{ clienta.id }}">
                                        <button type="submit" class="boton-accion">Premiado</button>
                                    </form>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% if clientes_inactivos %}
                <div class="alerta alerta-inactivo">
                    <h3>üìà Clientes para Reactivar</h3>
                    <ul>
                        {% for clienta in clientes_inactivos %}
                            <li class="item-lista-accion">
                                <span><strong>{{ clienta.nombre }} {{ clienta.apellido }}</strong></span>
                                <a href="https://wa.me/{{ clienta.telefono_wa }}?text={{ clienta.mensaje_wa }}" target="_blank" class="boton-accion accion-alerta">Contactar</a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
            
            {% if not cumpleaneras and not turnos_manana and not clientes_inactivos and not clientes_a_premiar and not alerta_vencimiento %}
                <p>No hay alertas para hoy. ¬°Todo tranquilo!</p>
            {% endif %}
        </div>
    </div>

    <div class="layout-col-lateral">
        <div class="card" style="margin-bottom: 25px;">
            <h2>{{ nombre_mes }} {{ ano }}</h2>
            <table class="mini-calendario">
                <thead><tr><th>Lu</th><th>Ma</th><th>Mi</th><th>Ju</th><th>Vi</th><th>S√°</th><th>Do</th></tr></thead>
                <tbody>
                    {% for semana in dias_del_mes %}
                    <tr>
                        {% for dia in semana %}
                            <td class="celda-dia {% if dia == 0 %}dia-otro-mes{% elif dia in dias_con_turnos %}dia-ocupado{% endif %}{% if ano == fecha_hoy.year and mes == fecha_hoy.month and dia == fecha_hoy.day %} dia-hoy{% endif %}" data-fecha="{{ ano }}-{{ '%02d'|format(mes) }}-{{ '%02d'|format(dia) }}">
                                {% if dia != 0 %}<div class="dia-numero">{{ dia }}</div>{% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>Configuraci√≥n</h2>
            <form action="/panel" method="post">
                <div class="form-group">
                    <label>Premiar cada:</label>
                    <div class="config-fidelizacion">
                        <input type="number" name="meta_fidelizacion" min="1" value="{{ meta_actual }}" class="form-control">
                        <span>servicios.</span>
                    </div>
                </div>
                <button type="submit">Guardar</button>
            </form>
        </div>
    </div>
</div>

<div id="modal-turno" class="modal-oculto">
    <div class="modal-contenido">
        <span class="modal-cerrar">&times;</span>
        <h3>Agendar Nuevo Turno</h3>
        <div id="error-container-modal"></div>
        <form action="/agregar_turno" method="post">
            <div class="form-group">
                <label for="cliente_id_modal">Cliente:</label>
                <select id="cliente_id_modal" name="cliente_id" required class="form-control">
                    <option value="">Seleccionar cliente...</option>
                    {% for cliente in clientes %}
                        <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="servicio_id_modal">Servicio:</label>
                <select id="servicio_id_modal" name="servicio_id" required class="form-control">
                    <option value="">Seleccionar servicio...</option>
                    {% for servicio in servicios %}
                         <option value="{{ servicio.id }}">{{ servicio.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="modal-fecha">Fecha:</label>
                <input type="date" id="modal-fecha" name="fecha" required class="form-control">
            </div>
            <div class="form-group">
                <label for="hora_modal">Hora:</label>
                <input type="time" id="hora_modal" name="hora" required class="form-control">
            </div>
            <button type="submit" style="width: 100%;">Agendar Turno</button>
        </form>
    </div>
</div>

<script>
    // Script del pop-up del panel
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('modal-turno');
        if (!modal) return;
        
        const form = modal.querySelector('form');
        const campoFecha = modal.querySelector('#modal-fecha');
        const errorContainer = modal.querySelector('#error-container-modal');
        const spanCerrar = modal.querySelector('.modal-cerrar');

        const abrirModal = (fecha) => {
            if (!fecha) return;
            form.reset();
            errorContainer.innerHTML = '';
            campoFecha.value = fecha;
            modal.classList.remove('modal-oculto');
            modal.classList.add('modal-visible');
        };

        document.querySelectorAll('.mini-calendario .celda-dia').forEach(celda => {
            celda.addEventListener('click', function() {
                const fecha = this.dataset.fecha;
                if (fecha) {
                    abrirModal(fecha);
                }
            });
        });

        form.addEventListener('submit', function(event) {
            event.preventDefault();
            errorContainer.innerHTML = '';
            const formData = new FormData(form);
            fetch('/agregar_turno', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    modal.classList.add('modal-oculto');
                    window.location.reload(); 
                } else {
                    errorContainer.innerHTML = `<div class="alerta flash-error">${data.message}</div>`;
                }
            })
            .catch(error => {
                errorContainer.innerHTML = `<div class="alerta flash-error">Error de conexi√≥n. Intentalo de nuevo.</div>`;
            });
        });

        const cerrarModal = () => {
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-oculto');
            if (errorContainer) {
                errorContainer.innerHTML = '';
            }
        };

        if (spanCerrar) {
            spanCerrar.addEventListener('click', cerrarModal);
        }
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                cerrarModal();
            }
        });
    });

    // === SCRIPT MEJORADO PARA MARCAR ALERTAS COMO COMPLETADAS ===
    document.querySelectorAll('.accion-alerta').forEach(boton => {
        boton.addEventListener('click', function(event) {
            // 1. Prevenimos que el navegador se vaya a WhatsApp inmediatamente
            event.preventDefault();

            // 2. Buscamos el elemento <li> que contiene al bot√≥n
            const itemAlerta = event.target.closest('li');
            
            if (itemAlerta) {
                // 3. Le agregamos la clase para que se ponga gris y se desactive
                itemAlerta.classList.add('alerta-item-completado');
            }

            // 4. Ahora s√≠, abrimos la pesta√±a de WhatsApp manualmente
            const url = event.target.href; // Obtenemos la URL del bot√≥n
            if (url) {
                window.open(url, '_blank');
            }
        });
    });
</script>
{% endblock %}